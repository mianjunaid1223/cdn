const bgModules = {
    "jd-shape": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/AbstractShapeBg.module.js").then(m => m.AbstractShapeBg),
    "jd-fluid": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/AestheticFluidBg.module.js").then(m => m.AestheticFluidBg),
    "jd-blob": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/BigBlobBg.module.js").then(m => m.BigBlobBg),
    "jd-dot": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/BlurDotBg.module.js").then(m => m.BlurDotBg),
    "jd-gradient": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/BlurGradientBg.module.js").then(m => m.BlurGradientBg),
    "jd-mosaic": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/TrianglesMosaicBg.module.js").then(m => m.TrianglesMosaicBg),
    "jd-cubes": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/RandomCubesBg.module.js").then(m => m.RandomCubesBg),
    "jd-waves": () => import("https://cdn.jsdelivr.net/gh/mianjunaid1223/cdn@main/jsm/WavyWavesBg.module.js").then(m => m.WavyWavesBg)
};
const backgroundTypes = [
    "jd-shape",
    "jd-fluid",
    "jd-dot",
    "jd-gradient",
    "jd-mosaic",
    "jd-cubes",
    "jd-waves",
    "jd-blob",
];

const defaultColors = ["#D1ADFF", "#98D69B", "#FAE390", "#FFACD8", "#7DD5FF", "#D1ADFF"];

console.log('Available background types: ' + backgroundTypes.join(', '));

const activeBackgrounds = new Map();
const elementStates = new Map();

function parseColorsFromId(id) {
    const colorMatch = id.match(/-\[(.*?)\]$/);
    if (colorMatch) {
        if (!colorMatch[1].trim()) {
            return defaultColors;
        }
        const colors = colorMatch[1].split(',')
            .map(color => color.trim())
            .filter(color => color.length > 0);
        
        return colors.length > 0 ? colors : defaultColors;
    }
    return null;
}

function getBackgroundTypeFromId(id) {
    const baseId = id.replace(/-\[.*?\]$/, '');
    return backgroundTypes.find(type => baseId === type) || null;
}

function destroyBackground(element) {
    const instance = activeBackgrounds.get(element);
    if (instance) {
        if (typeof instance.destroy === 'function') {
            instance.destroy();
        }
        activeBackgrounds.delete(element);
    }
}

async function applyBackground(element, bgClass) {
    if (bgModules[bgClass]) {
        destroyBackground(element);
        
        const customColors = parseColorsFromId(element.id);
        const colors = customColors || defaultColors;
        
        const BgClass = await bgModules[bgClass]();
        const instance = new BgClass({
            dom: element,
            colors,
            seed: 1000,
            loop: true
        });
        activeBackgrounds.set(element, instance);
        elementStates.set(element, bgClass);
    }
}

async function handleViewTransition(callback) {
    if (document.startViewTransition) {
        return document.startViewTransition(callback);
    } else {
        return callback();
    }
}

async function initBackground() {
    await handleViewTransition(async () => {
        const elements = document.querySelectorAll('[id^="jd-"]');
        for (const element of elements) {
            const bgType = getBackgroundTypeFromId(element.id);
            if (bgType) {
                const previousBgClass = elementStates.get(element);
                if (bgType !== previousBgClass) {
                    await applyBackground(element, bgType);
                }
            }
        }

        for (const [element, _] of activeBackgrounds) {
            if (!element.isConnected) {
                destroyBackground(element);
                elementStates.delete(element);
            }
        }
    });
}

const observer = new MutationObserver((mutations) => {
    let shouldUpdate = false;

    mutations.forEach(mutation => {
        if (mutation.type === 'attributes' && mutation.attributeName === 'id') {
            const element = mutation.target;
            if (element.id.startsWith('jd-')) {
                shouldUpdate = true;
            }
        } else if (mutation.type === 'childList') {
            mutation.addedNodes.forEach(node => {
                if (node.nodeType === 1 && node.id?.startsWith('jd-')) {
                    shouldUpdate = true;
                }
            });
            mutation.removedNodes.forEach(node => {
                if (node.nodeType === 1 && node.id?.startsWith('jd-')) {
                    shouldUpdate = true;
                }
            });
        }
    });

    if (shouldUpdate) {
        initBackground();
    }
});

let resizeTimeout;
window.addEventListener("resize", () => {
    clearTimeout(resizeTimeout);
    resizeTimeout = setTimeout(initBackground, 250);
});

window.addEventListener("DOMContentLoaded", () => {
    initBackground();
    
    observer.observe(document.body, {
        attributes: true,
        attributeFilter: ['id'],
        childList: true,
        subtree: true
    });
});

window.addEventListener("unload", () => {
    observer.disconnect();
    activeBackgrounds.forEach((instance, element) => {
        destroyBackground(element);
    });
});
